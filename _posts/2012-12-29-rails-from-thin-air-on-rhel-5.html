---
layout: post
title: "Rails from Thin Air on RHEL 5"
date: 2012-12-29
comments: false
---

<div class='post'>
<br />I'm completing a draconian exercise which is teaching me many lessons about installation and configuration whether I like it or not. The best I can do, as I struggle along, is to write about my experience. I certainly don't want to have to do this again from scratch, so after I complete each step I'm adding it to a script.<br /><br />The scene: I work for a very big company. Like many big companies, there are many rules in place that govern access to particular machines. I am starting a brand new Rails project and have had to overcome a number of obstacles to ready my team for deployment. Here are the bullet points:<br /><br /><ul><li>A cluster of Red Hat Enterprise Linux Servers, release 5.6 (Tikanga)</li><li>Bash</li><li>wget</li><li>No root access</li><li>No ability to use sudo, ever</li></ul><br />The requirement, a working Ruby and Rails project, has a handful of dependencies: libxml2, libxslt, bz2, SQLite3 version &gt;= 3.6, Python version &gt;= 2.6. None of these are installed with RHEL 5 out of the box, so I'm going to build all of them.<br /><br /><b>Setting up in vendor/</b><br />First I'll create a directory underneath my vendor/ directory in RAILS_HOME because "<a href="http://ryan.mcgeary.org/2011/02/09/vendor-everything-still-applies/" target="_blank">vendor everything still applies</a>." I call it setup/. Here is where I will put everything my server needs to run my application. I'll have my installation script and src/ and local/ directories.<br /><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">joe@warpaint:~/dev/tddominate/vendor$ ls</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">setup &nbsp;setup_env.bat &nbsp;src</span></span><br /><br />Next it's time to create a bash script. I set it to exit on any command failure with set -e and create some variables, beginning with SETUP_DIR. SETUP_DIR is set to be the directory where I've written my script, regardless of the location from which the script is executed (<a href="http://stackoverflow.com/a/246128/1617395" target="_blank">thanks to StackExchange</a> for help with this):<br /><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">#!/bin/bash</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">set -e</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">SETUP_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &amp;&amp; pwd )"</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">SETUP_DIR_SRC="$SETUP_DIR/src"</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">SETUP_DIR_LOCAL="$SETUP_DIR/local</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">mkdir -p $SETUP_DIR_LOCAL</span></span><br /><span style="background-color: #cccccc;"><br /></span><b>Ruby and Rubygems</b><br />Ruby and Rubygems are easy installs for me despite my inability to use RVM on these machines (permission issue).<br /><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">tar xzvf ruby-1.9.3-p327.tar.gz</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd ruby-1.9.3-p327</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">./configure --prefix=/my/location/ruby 15 make</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">make install</span></span><br /><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">echo "export PATH=/my/location/ruby/bin:$PATH" &gt;&gt; ~/.bashrc</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">echo "export HTTP_PROXY=http://proxy.net:8080" &gt;&gt; ~/.bashrc</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">echo "export HTTPS_PROXY=https://proxy.net:8080" &gt;&gt; ~/.bashrc</span></span><br /><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">. ~/.bashrc</span></span><br /><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"><br /></span><br /><div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">tar xvf rubygems-1.8.24.tar</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd rubygems-1.8.24</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">ruby setup.rb --prefix=/my/location</span></span></div><div><br /></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">gem install bundler</span></span></div><div><br /></div><div>I set the HTTP_PROXY and HTTPS_PROXY environment variables so that rubygems can do its thing.</div><div><br /></div><div><b>Prepare for Nokogiri (building libxml2 and libxslt from source)</b></div><div>OK, enough of the easy stuff. Enter libxml and libxslt. With no rpm and no sudo, I'm going to have to get my hands dirty:</div><div><br /></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">wget ftp://xmlsoft.org/libxml2/libxml2-2.7.8.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">tar xzvf libxml2-2.7.8.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC/libxml2-2.7.8</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">./configure --prefix=$SETUP_DIR_LOCAL ; make ; make install</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">wget ftp://xmlsoft.org/libxml2/libxslt-1.1.28.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">tar xzvf libxslt-1.1.28.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd $SETUP_DIR_SRC/libxslt-1.1.28</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">./configure --prefix=$SETUP_DIR_LOCAL \&nbsp;</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; --with-libxml-prefix=$SETUP_DIR_LOCAL \&nbsp;</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; --with-libxml-include-prefix=$SETUP_DIR_LOCAL/include \&nbsp;</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; --with-libxml-libs-prefix=$SETUP_DIR_LOCAL/lib</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">make ; make install</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></span></div><div>If you prayed to the right Linux gods, this will work for you with a little tinkering. Next I'll add the right configuration to bundler for install time. Note that the libxml2 specified is the source directory and the libxslt specified is the installation directory.</div><div><br /></div><div><span style="font-family: Courier New, Courier, monospace;"><span style="background-color: #cccccc;">bundle config build.nokogiri --with-xml2-dir=$SETUP_DIR_SRC/libxml2-2.7.8 --with-xslt-dir=$SETUP_DIR_LOCAL</span></span></div><div><br /></div><div><b>Runtime for ExecJS</b></div><div>Now you're all set to bundle install. Your gems install flawlessly. You're tempted to celebrate. Then you run rspec. Or rails s. Or rake. And you still have problems. Something in the way of:</div><div><br /></div><div><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">Could not find a JavaScript runtime. See https://github.com/sstephenson/execjs for a list of available runtimes.</span></div></div><div><br /></div><div><div>I still have work to do.</div><div><br /></div><div>Sam Stephenson and Josh Peek created something awesome with <a href="https://github.com/sstephenson/execjs" target="_blank">ExecJS</a>. They are the ones that make executing Javascript through Ruby possible. Under the hood, in almost everything we do in Rails applications these days, ExecJS is there. It's a workhorse akin to Nokogiri. There's just one thing they ask of you to get started - that you actually have a Javascript runtime! Your Gemfile is already giving you a hint:</div><div><br /></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"># See https://github.com/sstephenson/execjs#readme for more supported runtimes</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"># gem 'therubyracer'</span></div><div><br /></div><div>As noted, there are other runtime options, but in order to build the dependencies -- in this case libv8 -- I need to upgrade my version of Python to 2.7. On a debian system,&nbsp;Python does not come with bz2 support out of the box. It has to be configured to do this.&nbsp;Red Hat 5 does not come with the bz2 developer library, just the binaries. So I'll download and build it.&nbsp;</div><div><br /></div><div>There is a specific way to build bz2 so that it shares its libraries with others (like Python) and trying to figure it out nearly drained my remaining life force. I have to make and install bz2 twice, strange though it may seem. This is so it knows to build a shared library that on which Python depends. &nbsp;Since I am building bz2 and installing it in a custom location (using the PREFIX option), I &nbsp;then need to tell Python where it's been installed. Borrowing heavily from a script and <a href="http://rajaseelan.com/2012/01/28/installing-python-2-dot-7-2-on-centos-5-dot-2/#disqus_thread" target="_blank">blog post by @rajaleen</a>, here's what I did:</div><div><br /></div><div>I export my PREFIX as an environment variable:</div><div><br /></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">export PREFIX=/path/to/custom_install</span></span></div><div><br /></div><div>Make and install bz2 twice</div><div><div><br /></div></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make -f Makefile_libbz2_so</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make install PREFIX=$PREFIX</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make install PREFIX=$PREFIX</span></div><div><br /></div><div>I set the necessary environment variables for Python compilation:</div><div><br /></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">export C_INCLUDE_PATH=/path/to/custom_install/include</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">export CPLUS_INCLUDE_PATH=$C_INCLUDE_PATH</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">export LIBRARY_PATH=/path/to/custom_install/lib</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">export LD_RUN_PATH=$LIBRARY_PATH</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="background-color: white; font-family: Times, Times New Roman, serif;">Finally, I use the --enable-shared option when configuring Python. This tells Python to build both its static and dynamic libraries:</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"><br /></span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">cd Python-2.7.3</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">./configure --prefix=$PREFIX --enable-shared</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">make install</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;"><br /></span></div><div>Now our gem install libv8 works flawlessly and I &nbsp;uncomment gem 'therubyracer' from our Gemfile and add a requirement for libv8:</div><div><br /></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">gem 'libv8'&nbsp;</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">gem 'therubyracer'&nbsp;</span></span></div><div><br /></div><div><b>SQLite3 is laughably outdated</b></div><div>bundle install works flawlessly once again, and when I run rspec, the specs run! But they are failing for strange reasons:</div><div><br /></div><div><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">Failure/Error: environment = Environment.make! ActiveRecord::StatementInvalid: SQLite3::SQLException: near "SAVEPOINT": syntax error: SAVEPOINT active_record_1</span></div><div><br /></div><div><div>From the SQLite3 documentation: &nbsp;"SAVEPOINTs are a method of creating transactions, similar to BEGIN and COMMIT, except that the SAVEPOINT and RELEASE commands are named and may be nested." SAVEPOINTs have been supported since version 3.6.8. However, my RHEL 5 machine (and I believe all others as well) comes bundled with version 3.3.6, which was released in June of 2006. Time to upgrade.</div><div><br /></div><div>Actually, this was part of the process was pleasantly easy with only one catch. I'm going to configure and install SQLite3 with our --prefix the same as always:</div><div><br /></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">wget http://www.sqlite.org/sqlite-autoconf-3071501.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">tar xzvf sqlite-autoconf-3071501.tar.gz</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">cd sqlite-autoconf-3071501</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">./configure --prefix=$PREFIX</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">make</span></span></div><div><span style="background-color: #cccccc;"><span style="font-family: Courier New, Courier, monospace;">make install</span></span></div><div><br /></div><div>When I run rspec, I still see the same errors. This is because the sqlite3 gem needs to be reconfigured. My method: uninstall/reinstall, and tell bundler about my configurations:</div><div><br /></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">bundle exec gem uninstall sqlite3</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">bundle config build.sqlite3 --with-sqlite3-dir=$PREFIX</span></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">bundle install</span></div><div><br /></div><div>One potential roadblock that may occur is the following when you try to run your specs:</div><div><br /></div><div><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">sqlite3-ruby-1.3.1/lib/sqlite3/sqlite3_native.so: undefined symbol:&nbsp;</span></div><div><span style="font-family: Helvetica Neue, Arial, Helvetica, sans-serif;">sqlite3_initialize&nbsp;</span></div><div><br /></div><div>The solution comes <a href="https://groups.google.com/forum/#!msg/sqlite3-ruby/crbvv358SeY/fY_-c3y134IJ" target="_blank">courtesy of Aaron Patterson</a>. To make the sqlite3 gem play nicely, I &nbsp;need to add my PREFIX/lib directory to the LD_LIBRARY_PATH:</div><div><br /></div><div><span style="background-color: #cccccc; font-family: Courier New, Courier, monospace;">export LD_LIBRARY_PATH=$PREFIX/lib:$LD_LIBRARY_PATH</span></div><div><br /></div><div>Finally, I'm at the finish line. I run rspec:</div><div><br /></div><div><br /></div><div>...............................</div><div><br /></div><div><br /></div><div><br /></div><div><div>Finished in 1.02 seconds</div><div>31 examples, 0 failures, 0 pending</div><div><br /></div><div><br /></div><div><b>Ahh, that's the stuff! Happy coding!</b></div></div></div></div><div><br /></div></div>
